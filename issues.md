# Issue Report: Permit2 EIP-712 Domain Version Mismatch in doppler-router

## Summary

When using `doppler-router`'s `getPermitSignature` function to generate EIP-712 signatures for the Permit2 contract (`0x000000000022D473030F116dDEE9F6B43aC78BA3`), `Permit2.InvalidSignature` errors occur. This is due to a likely mismatch in the EIP-712 domain separator used by `getPermitSignature` compared to the one used by the deployed Permit2 contract.

## Context

This issue was identified while integrating a custom ERC20 token as a numeraire in a miniapp that uses `doppler-router` and Permit2 for token approvals with the Universal Router.

## Problem Details

Swaps involving Permit2 approvals consistently failed with `ExecutionFailed(0, 0x756688fe)` (Permit2.InvalidSignature) when the signature was generated by `doppler-router`'s `getPermitSignature`.

## Root Cause Analysis

The Permit2 contract's EIP-712 domain separator is derived using an **empty version string**. This can be inferred from its constructor and standard EIP-712 practices for contracts that do not explicitly version their domain. The relevant EIP-712 domain typehash for Permit2 would be `EIP712Domain(string name,uint256 chainId,address verifyingContract)`.

It is suspected that `doppler-router`'s `getPermitSignature` function, when preparing the domain object for `signTypedData` for Permit2, incorrectly includes a `version` field (e.g., `version: "1"`). This results in a different domain separator being calculated by the client compared to the one expected by the Permit2 contract, leading to signatures that Permit2 deems invalid.

## Solution / Workaround Implemented

The issue was resolved in the miniapp by bypassing `doppler-router`'s `getPermitSignature` and manually implementing the EIP-712 signing process for `PermitSingle` data using `viem`'s `walletClient.signTypedData`.

The key change was constructing the EIP-712 domain object **without** the `version` field:

```typescript
const domain = {
  name: "Permit2",
  chainId: currentChainId, // e.g., from publicClient.chain.id
  verifyingContract: addresses.permit2, // Permit2 contract address
  // NO 'version' field
} as const;
```

Signatures generated using this domain object were successfully validated by:
1.  Direct simulation of `Permit2.permit(...)` calls.
2.  Successful execution of swaps via the Universal Router using these manually generated signatures.

## Evidence

- Initial failures with `doppler-router`'s `getPermitSignature` resulted in `Permit2.InvalidSignature` (revert data `0x756688fe` from Universal Router, or `0x815e1d64` from direct Permit2 calls).
- Successful calls to `Permit2.permit` and subsequent successful swaps were achieved consistently after switching to manual EIP-712 signing with the corrected domain (omitting `version`).

## Recommendation

It is recommended that the `doppler-router` library's `getPermitSignature` function be reviewed and updated. Specifically, when generating signatures for the Permit2 contract, the EIP-712 domain object used internally should omit the `version` field to align with the Permit2 contract's domain separator.

This will ensure that signatures generated by `doppler-router` are valid for Permit2, allowing for seamless integration with Permit2-based approval flows.
